{% extends 'base/web-base.html' %}

{% load static %}

{% block container %}


{% include 'includes/header.html' %}



<section class="wrapper p-40">
    <div class="flex  items-center border rounded-2xl px-6 py-3 bg-white">
        <div class="">
            <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
                <form method="post" id="seat-booking-form">
                    {% csrf_token %}
                    <input type="hidden" name="seat_ids" id="seat-ids">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <p class="text-gray-700 font-semibold mb-4">Upper</p>
                            <div class="grid grid-cols-8 gap-4" id="upper-row">
                                {% for seat in seats %}
                                    {% if seat.seat_type == 'upper' %}
                                        <div 
                                            class="seat w-12 h-8 flex items-center justify-center rounded cursor-pointer 
                                            {% if seat.status == 'booked' %} bg-red-300 {% else %} bg-gray-300 {% endif %}" 
                                            data-seat-id="{{ seat.id }}"
                                            data-status="{{ seat.status }}">
                                            {{ seat.seat_number }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Lower Row -->
                        <div>
                            <p class="text-gray-700 font-semibold mb-4">Lower</p>
                            <div class="grid grid-cols-8 gap-4" id="lower-row">
                                {% for seat in seats %}
                                    {% if seat.seat_type == 'lower' %}
                                        <div 
                                            class="seat w-12 h-8 flex items-center justify-center rounded cursor-pointer 
                                            {% if seat.status == 'booked' %} bg-red-300 {% else %} bg-gray-300 {% endif %}" 
                                            data-seat-id="{{ seat.id }}"
                                            data-status="{{ seat.status }}">
                                            {{ seat.seat_number }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Book</button>
                </form>
            </div>
        </div>
            

        <div class="ml-20">
            <div class="bg-white shadow p-4 rounded-lg max-w-md mx-auto" id="boarding-points">
                <div class="mt-6 flex justify-between items-center">
                    <div class="text-gray-700">
                        <span class="font-medium">Seat Selected:</span> <span>0</span>
                    </div>
                    <div class="text-gray-700">
                        <span class="font-medium">Base Fare:</span> <span>&#8377; 0</span>
                    </div>
                </div>
                
                <button disabled class="mt-4 w-full bg-gray-300 seat text-gray-500 py-2 rounded-lg font-medium cursor-not-allowed">Continue</button>
            </div>
        </div>
    </div>

    <div>
        {% for bus in bus %}
        <div class="border bg-white px-5 md:px-20 py-5 md:py-10 mt-5 rounded-2xl">
        <div class="flex flex-wrap justify-between items-center">
            <img class="w-[100px] h-[100px]" src="{{ bus.image.url }}" alt="Logo">
            <ul class="ml-14">
            <h1 class="text-[#000] text-[20px] font-semibold">{{ bus.buses }}</h1>
            <h2 class="text-[16px] font-medium text-gray-400">{{ bus.bus_numbers }}</h2>
            </ul>
            <ul class="ml-14">
            <h3 class="text-[20px] font-semibold text-black">{{ bus.departure_time|date:"H:i" }}</h3>
            <h5 class="text-[16px] font-medium text-gray-400">{{ bus.departure_code }}</h5>
            </ul>
            <ul class="ml-14">
            <span class="text-[16px] font-medium text-gray-400">
                {{ bus.duration }}
            </span>
            <div class="border-b-2 border-gray-500 w-14"></div>
            <h3 class="text-[16px] font-medium text-gray-400">{{ bus.stops }}</h3>
            </ul>
            <ul class="ml-14">
            <span class="text-[20px] font-semibold text-black">{{ bus.arrival_time|date:"H:i" }}</span>
            <p class="text-[16px] font-medium text-[#ff2a2a]">{{ bus.arrival_code }}</p>
            </ul>
            <ul class="ml-14">
            <h1 class="text-[#000] text-[20px] font-semibold">₹{{ bus.price }}</h1>
            {% if bus.discount %}
            <h2 class="text-[16px] font-medium text-orange-400">Extra ₹{{ bus.discount}} Off</h2>
            {% endif %}
            </ul>
            <div class="transition-transform bg-orange-400 duration-300 ml-14 hover:scale-110 hover:bg-orange-500 border px-3 py-2 rounded-2xl">
                <a href="{% url 'web:bus-seat' %}" class=" block text-[30px] font-semibold text-white">Book</a>
            </div>
        </div>
        </div>
    {% endfor %}
    </div>
</section>


<script>
    const selectedSeats = new Set();

    document.querySelectorAll('.seat').forEach(seat => {
        seat.addEventListener('click', function() {
            const seatId = this.getAttribute('data-seat-id');
            const status = this.getAttribute('data-status');
            
            if (status === 'booked') return; // Prevent selecting booked seats
            
            if (selectedSeats.has(seatId)) {
                selectedSeats.delete(seatId);
                this.classList.remove('bg-green-300');
                this.classList.add('bg-gray-300');
            } else {
                selectedSeats.add(seatId);
                this.classList.remove('bg-gray-300');
                this.classList.add('bg-green-300');
            }

            document.getElementById('seat-ids').value = Array.from(selectedSeats).join(',');
        });
    });
</script>


<script>
    setInterval(() => {
        fetch('/buses/{{ buses.id }}/seats/status/')
            .then(response => response.json())
            .then(data => {
                data.forEach(seat => {
                    const seatElement = document.querySelector(`[data-seat-id="${seat.id}"]`);
                    if (seat.status === 'booked') {
                        seatElement.classList.remove('bg-gray-300', 'bg-green-300');
                        seatElement.classList.add('bg-red-300');
                        seatElement.setAttribute('data-status', 'booked');
                    }
                });
            });
    }, 5000);
    
</script>
{% endblock %}